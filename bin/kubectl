#!/usr/bin/env bash
set -Ee -o pipefail
#
# MIT License
#
# Copyright (c) 2020 djeeno
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# ---
#
# Install
#
#   # for curl
#   sudo bash -cx "curl -LR https://github.com/djeeno/kubectl-wrapper/releases/latest/download/kubectl -o /usr/local/bin/kubectl && chmod -v +x /usr/local/bin/kubectl"
#
#   # for wget
#   sudo bash -cx "wget -c https://github.com/djeeno/kubectl-wrapper/releases/latest/download/kubectl -O /usr/local/bin/kubectl && chmod -v +x /usr/local/bin/kubectl"
#



# var (common)
httpGet="$( { command -v curl 1>/dev/null && printf "curl -fLRSs"; } || { command -v wget 1>/dev/null && printf "wget -O- -q"; } )"; export httpGet
script_dir=$(cd "$(dirname "$0")" && pwd)
script_fullpath="${script_dir:?}/$(basename "$0")"



# func
export  pipe_debug="exec awk \"{print \\\"\\\\033[00m\$(date +%Y-%m-%dT%H:%M:%S%z) [ debug] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin" &&  debugln () { [[ $DEBUG != true ]] || echo "${*:?"log content"}" | sh -c "${pipe_debug:?}"  1>&2; }
export   pipe_info="exec awk \"{print \\\"\\\\033[34m\$(date +%Y-%m-%dT%H:%M:%S%z) [  info] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin" &&   infoln () { echo "${*:?"log content"}" | sh -c "${pipe_info:?}"   1>&2; }
export     pipe_ok="exec awk \"{print \\\"\\\\033[32m\$(date +%Y-%m-%dT%H:%M:%S%z) [    ok] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin" &&     okln () { echo "${*:?"log content"}" | sh -c "${pipe_ok:?}"     1>&2; }
export pipe_notice="exec awk \"{print \\\"\\\\033[01m\$(date +%Y-%m-%dT%H:%M:%S%z) [notice] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin" && noticeln () { echo "${*:?"log content"}" | sh -c "${pipe_notice:?}" 1>&2; }
export   pipe_warn="exec awk \"{print \\\"\\\\033[33m\$(date +%Y-%m-%dT%H:%M:%S%z) [  warn] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin" &&   warnln () { echo "${*:?"log content"}" | sh -c "${pipe_warn:?}"   1>&2; }
export  pipe_error="exec awk \"{print \\\"\\\\033[31m\$(date +%Y-%m-%dT%H:%M:%S%z) [ error] \\\"\\\$0\\\"\\\\033[0m\\\"}\" /dev/stdin" &&  errorln () { echo "${*:?"log content"}" | sh -c "${pipe_error:?}"  1>&2; }
__displayContext () {
  printf '\033[34m%s %s\033[0m \033[01m%s\033[0m\n' "$(date +%Y-%m-%dT%H:%M:%S%z) [  info]" "${kubectl_bin:?} config current-context:" "$("${kubectl_bin:?}" config current-context 2>/dev/null || echo current-context is not set; exit 1)" 1>&2
}
__confirmContext () {
  printf '\033[33m%s %s\033[0m'   "$(date +%Y-%m-%dT%H:%M:%S%z) [  warn]" "press ENTER KEY to continue... " 1>&2
  read -r;
}
__setupKubectl () {
  local kubectl_bin="${1:?}"
  if [[ ! -f ${kubectl_bin:?} ]]; then
    # If not amd64,
    if [[ $(uname -m) != x86_64 ]]; then
      errorln "Installation kubectl for architecture $(uname -m) is not supported"
      return 1
    fi
    # If exists and not file, meke backup
    if [[ -e ${kubectl_bin:?} ]]; then
      mv -v "${kubectl_bin:?}" ".${kubectl_bin:?}.backup"
    fi
    VERSION=$(${httpGet:?"curl or wget are required"} https://storage.googleapis.com/kubernetes-release/release/stable.txt)
    SYSTEM=$(uname -s | tr '[:upper:]' '[:lower:]')
    mkdir -p "$(dirname "${kubectl_bin}")"
    cmd="${httpGet:?"curl or wget are required"} https://storage.googleapis.com/kubernetes-release/release/${VERSION:?}/bin/${SYSTEM:?}/amd64/kubectl >${kubectl_bin:?}"
    infoln "RUN: ${cmd:?}" && if [[ -w ${kubectl_bin:?} ]] || { [[ -w $(dirname "${kubectl_bin:?}") ]] && [[ ! -e ${kubectl_bin:?} ]]; }; then bash -c "${cmd:?}"; else sudo -u root bash -c "${cmd:?}"; fi
  fi
  if [[ ! -x ${kubectl_bin:?} ]]; then
    cmd="chmod +x ${kubectl_bin:?}"
    infoln "RUN: ${cmd:?}" && if [[ -w ${kubectl_bin:?} ]] || { [[ -w $(dirname "${kubectl_bin:?}") ]] && [[ ! -e ${kubectl_bin:?} ]]; }; then bash -c "${cmd:?}"; else sudo -u root bash -c "${cmd:?}"; fi
  fi
}
__updateSelf () {
  infoln "Update self."
  cmd="${httpGet:?"curl or wget are required"} https://github.com/djeeno/kubectl-wrapper/releases/latest/download/kubectl >\"$0\"; chmod -v +x \"$0\""
  infoln "RUN: ${cmd:?}" && if [[ -w $0 ]] || { [[ -w $(dirname "$0") ]] && [[ ! -e $0 ]]; }; then bash -c "${cmd:?}"; else sudo -u root bash -c "${cmd:?}"; fi
  infoln "Updated."
  exit 0
}



# main
__main () {
  # subcommands
  if [[ $1 = self-update ]]; then __updateSelf; fi
  # kubectl
  local kubectl_bin
  kubectl_bin=$(
    echo "$PATH" | tr : "\n" |
      # check binary command existence
      xargs -I@ sh -c "grep -q \"[^[:print:][:blank:]]\" \"@/kubectl\" && echo \"@/kubectl\"" 2>/dev/null |
      # avoid to infinite loop
      grep -v "^${script_fullpath:?}" |
      # first file fullpath in PATH
      head -n 1 | cut -d: -f1
  ) || true
  debugln "kubectl in PATH (kubectl_bin): $kubectl_bin"
  if [[ ! -x $kubectl_bin ]] || [[ ! -f $kubectl_bin ]]; then
    kubectl_bin="${HOME:?}/bin/kubectl"
    __setupKubectl "${kubectl_bin:?}"
  fi
  # KUBECTL_EXTERNAL_DIFF
  export KUBECTL_EXTERNAL_DIFF="${KUBECTL_EXTERNAL_DIFF:-$(command -v cdiff)}"
  # main
  if echo "$*" | grep -q -- "--context[[:space:]=]"; then
    # shellcheck disable=SC2001
    infoln "RUN: ${kubectl_bin:?} $*"
    "${kubectl_bin:?}" "$@" </dev/stdin
  elif [[ $KUBECTL_CONTEXT ]]; then
    infoln "RUN: ${kubectl_bin:?} --context=${KUBECTL_CONTEXT:?} $*"
    "${kubectl_bin:?}" --context="${KUBECTL_CONTEXT:?}" "$@" </dev/stdin
  else
    __displayContext
    # If NOT read only command,
    if [[ ! $# -le 1 ]] &&
      ! { echo " $* " | grep -Eq -- ' -h | --help | --dry-run[ =]'; } &&
      ! { echo " $* " | grep -Eq ' api-resources | api-version | cluster-info | completion | config | describe | diff | explain | get | logs | port-forward | top | version | wait '; }; then
      # confirm current-context
      if ! __confirmContext; then
        exit 1
      fi
    fi;
    # run
    KUBECTL_CONTEXT=$("${kubectl_bin:?}" config current-context 2>/dev/null)
    export KUBECTL_CONTEXT
    __main "$@"
  fi
}



# entrypoint
__main "$@"
